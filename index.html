<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>모임비 관리</title>

<link rel="manifest" href="manifest.json">

<!-- iOS PWA 지원 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icons/192.png">

<style>
:root {
  --bg: #f2f2f7;
  --card-bg: #ffffff;
  --text: #111;
  --muted: #666;
  --accent: #007aff;
  --good: #34c759;
  --bad: #ff3b30;
  --border: #d1d1d6;

  --font-large: 18px;
  --font-normal: 16px;
  --font-small: 14px;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
    "Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;
  color: var(--text);
}

/* Header */
header {
  position: sticky;
  top: 0;
  background: var(--accent);
  color: white;
  padding: 12px 10px 8px;
  font-size: 20px;
  font-weight: 600;
  text-align: center;
  z-index: 100;
}
header small {
  display: block;
  font-size: 12px;
  opacity: 0.9;
}

/* 상단 컨트롤 (모임명/이월금/백업) */
#topControls {
  padding: 8px 10px 4px;
  font-size: 13px;
  background: #f9f9fb;
  border-bottom: 1px solid var(--border);
}
#topControls span {
  display: inline-block;
  margin-right: 8px;
}
#topControls button {
  padding: 4px 8px;
  margin-right: 4px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 12px;
}

/* Card */
.card {
  background: var(--card-bg);
  margin: 12px;
  padding: 16px;
  border-radius: 14px;
  box-shadow: 0 3px 7px rgba(0,0,0,0.08);
  font-size: var(--font-normal);
  border: 1px solid rgba(0,0,0,0.05);
}
.card-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 6px;
}
.card-sub {
  font-size: var(--font-small);
  color: var(--muted);
  margin-bottom: 6px;
}

/* Buttons */
button {
  font-family: inherit;
}
.primary-btn {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  background: var(--accent);
  color: white;
  font-size: var(--font-large);
  font-weight: 600;
  border: none;
  margin-top: 6px;
}
.secondary-btn {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  font-size: var(--font-normal);
  border: 1px solid var(--border);
  background: white;
  margin-top: 6px;
}

/* FAB */
.add-btn {
  position: fixed;
  bottom: 90px;
  right: 18px;
  background: var(--accent);
  color: white;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  font-size: 36px;
  text-align: center;
  line-height: 56px;
  border: none;
  box-shadow: 0 4px 14px rgba(0,0,0,0.3);
  z-index: 120;
}

/* Nav */
nav {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: white;
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 100;
}
nav button {
  flex: 1;
  padding: 8px 0 10px;
  font-size: 14px;
  border: none;
  background: none;
  color: var(--muted);
}
nav button.active {
  color: var(--accent);
  font-weight: 600;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.35);
  z-index: 200;
}
.modal-content {
  width: 90%;
  max-width: 450px;
  background: white;
  margin: 80px auto;
  padding: 20px;
  border-radius: 14px;
  font-size: var(--font-normal);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}
input, select, textarea {
  width: 100%;
  padding: 12px;
  font-size: var(--font-normal);
  border-radius: 12px;
  border: 1px solid var(--border);
  margin: 6px 0 10px 0;
}
textarea { min-height: 60px; resize: vertical; }

.page {
  padding-bottom: 120px;
}

/* 테이블 */
table {
  border-collapse: collapse;
}
th, td {
  padding: 4px 6px;
  border: 1px solid #ddd;
}

/* 인쇄용 */
@media print {
  header, #topControls, nav, .add-btn, .no-print {
    display: none !important;
  }
  body {
    background: #fff;
  }
  .card {
    box-shadow: none;
    border: 1px solid #ccc;
    page-break-inside: avoid;
  }
}
</style>
</head>

<body>

<header>
  모임비 관리
  <small id="headerGroupName">여성선교회 2025년</small>
</header>

<div id="topControls" class="no-print">
  <span id="groupInfoText">모임: - / 이월금: $0.00</span>
  <button onclick="openGroupModal()">모임/이월 설정</button>
  <button onclick="exportBackup()">백업(JSON)</button>
  <button onclick="importBackup()">복원(JSON)</button>
  <input type="file" id="backupFile" style="display:none" accept="application/json" onchange="handleBackupFile(event)">
</div>

<!-- Pages -->
<div id="membersPage" class="page"></div>
<div id="depositPage" class="page" style="display:none"></div>
<div id="expensePage" class="page" style="display:none"></div>
<div id="fastInputPage" class="page" style="display:none"></div>
<div id="depositSummaryPage" class="page" style="display:none"></div>
<div id="expenseSummaryPage" class="page" style="display:none"></div>
<div id="summaryPage" class="page" style="display:none"></div>

<!-- Navigation -->
<nav class="no-print">
  <button id="navMembers" onclick="showPage('membersPage')">회원</button>
  <button id="navDeposit" onclick="showPage('depositPage')">입금</button>
  <button id="navExpense" onclick="showPage('expensePage')">지출</button>
  <button id="navFast" onclick="showPage('fastInputPage')">빠른입력</button>
  <button id="navSummary" onclick="showPage('summaryPage')">정산</button>
</nav>

<button class="add-btn no-print" onclick="openFAB()">＋</button>

<!-- Modals -->
<div id="groupModal" class="modal">
  <div class="modal-content">
    <h3>모임 / 이월금 설정</h3>
    <label>모임 이름</label>
    <input id="groupName" placeholder="예: 여성선교회 2025년">
    <label>전년도 이월금 (NZD)</label>
    <input id="groupOpening" type="number" step="0.01">
    <button class="primary-btn" onclick="saveGroup()">저장</button>
    <button class="secondary-btn" onclick="closeModal('groupModal')">닫기</button>
  </div>
</div>

<div id="memberModal" class="modal">
  <div class="modal-content">
    <h3>회원 추가/수정</h3>
    <input id="memberName" placeholder="이름">
    <input id="editingMemberId" type="hidden">
    <button class="primary-btn" onclick="saveMember()">저장</button>
    <button class="secondary-btn" onclick="closeModal('memberModal')">닫기</button>
  </div>
</div>

<div id="depositModal" class="modal">
  <div class="modal-content">
    <h3>입금 기록</h3>
    <label>회원</label>
    <select id="depositMemberSelect"></select>

    <label>월 (2〜12)</label>
    <input type="number" id="depositMonth" min="2" max="12">

    <label>금액 (NZD)</label>
    <input type="number" id="depositAmount" step="0.01">

    <label>종류</label>
    <select id="depositType">
      <option value="fee">회비</option>
      <option value="donation">Donation</option>
    </select>

    <label>메모</label>
    <input id="depositMemo" placeholder="비워두면 자동 생성">

    <input id="editingDepositId" type="hidden">

    <button class="primary-btn" onclick="saveDeposit()">저장</button>
    <button class="secondary-btn" onclick="closeModal('depositModal')">닫기</button>
  </div>
</div>

<div id="expenseModal" class="modal">
  <div class="modal-content">
    <h3>지출 기록</h3>
    <label>날짜</label>
    <input type="date" id="expenseDate">

    <label>금액 (NZD)</label>
    <input type="number" id="expenseAmount" step="0.01">

    <label>내용</label>
    <textarea id="expenseMemo" placeholder="예: 티타임, 점심, 선교헌금 등"></textarea>

    <input id="editingExpenseId" type="hidden">

    <button class="primary-btn" onclick="saveExpense()">저장</button>
    <button class="secondary-btn" onclick="closeModal('expenseModal')">닫기</button>
  </div>
</div>

<script>
/* ========== 1. 데이터 로드 / 기본 세팅 ========== */
let groups   = JSON.parse(localStorage.getItem("groups")   || "[]");
let members  = JSON.parse(localStorage.getItem("members")  || "[]");
let deposits = JSON.parse(localStorage.getItem("deposits") || "[]");
let expenses = JSON.parse(localStorage.getItem("expenses") || "[]");
let activeGroupId = Number(localStorage.getItem("activeGroupId") || 0);

/* 최초 실행 시 기본 모임 생성 */
if (!groups.length) {
  const gid = Date.now();
  groups.push({ id: gid, name: "여성선교회 2025년", openingBalance: 0 });
  activeGroupId = gid;
  saveAll();
}

function saveAll() {
  localStorage.setItem("groups",   JSON.stringify(groups));
  localStorage.setItem("members",  JSON.stringify(members));
  localStorage.setItem("deposits", JSON.stringify(deposits));
  localStorage.setItem("expenses", JSON.stringify(expenses));
  localStorage.setItem("activeGroupId", String(activeGroupId));
}

/* ========== 2. 공통 유틸 ========== */
function getActiveGroup() {
  return groups.find(g => g.id === activeGroupId) || groups[0];
}

function refreshHeader() {
  const g = getActiveGroup();
  if (!g) return;
  document.getElementById("headerGroupName").innerText = g.name;
  document.getElementById("groupInfoText").innerText =
    `모임: ${g.name} / 이월금: $${(g.openingBalance || 0).toFixed(2)}`;
}

/* ========== 3. 페이지 전환 / FAB / 모달 ========== */
function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  document.getElementById(id).style.display = "block";

  document.querySelectorAll("nav button").forEach(btn =>
    btn.classList.remove("active")
  );
  const map = {
    membersPage: "navMembers",
    depositPage: "navDeposit",
    expensePage: "navExpense",
    fastInputPage: "navFast",
    summaryPage: "navSummary",
    depositSummaryPage: "navDeposit",
    expenseSummaryPage: "navExpense"
  };
  const navId = map[id];
  if (navId) document.getElementById(navId).classList.add("active");

  renderAll();
}

function isVisible(id) {
  return document.getElementById(id).style.display === "block";
}

function openFAB() {
  if (isVisible("membersPage"))      openMemberModal();
  else if (isVisible("depositPage")) openDepositModal();
  else if (isVisible("expensePage")) openExpenseModal();
  else if (isVisible("fastInputPage")) alert("빠른 입력은 표에서 바로 수정 후 저장 버튼을 눌러주세요.");
}

function openModal(id) {
  document.getElementById(id).style.display = "block";
}
function closeModal(id) {
  document.getElementById(id).style.display = "none";
}

/* ========== 4. 모임(그룹) 설정 ========== */
function openGroupModal() {
  const g = getActiveGroup();
  document.getElementById("groupName").value = g?.name || "";
  document.getElementById("groupOpening").value = g?.openingBalance || 0;
  openModal("groupModal");
}
function saveGroup() {
  const name = document.getElementById("groupName").value.trim();
  const opening = Number(document.getElementById("groupOpening").value) || 0;
  if (!name) return alert("모임 이름을 입력하세요.");

  let g = getActiveGroup();
  if (!g) {
    const gid = Date.now();
    g = { id: gid, name, openingBalance: opening };
    groups.push(g);
    activeGroupId = gid;
  } else {
    g.name = name;
    g.openingBalance = opening;
  }
  saveAll();
  closeModal("groupModal");
  refreshHeader();
  renderAll();
}

/* ========== 5. 회원 ========== */
function openMemberModal(id=null) {
  document.getElementById("editingMemberId").value = id || "";
  document.getElementById("memberName").value = "";

  if (id) {
    const m = members.find(x => x.id === id);
    if (m) document.getElementById("memberName").value = m.name;
  }
  openModal("memberModal");
}

function saveMember() {
  const idStr = document.getElementById("editingMemberId").value;
  const name  = document.getElementById("memberName").value.trim();
  if (!name) return alert("이름을 입력하세요.");

  if (idStr) {
    const id = Number(idStr);
    const idx = members.findIndex(m => m.id === id);
    if (idx > -1) members[idx].name = name;
  } else {
    members.push({
      id: Date.now(),
      groupId: activeGroupId,
      name
    });
  }
  saveAll();
  closeModal("memberModal");
  renderMembersPage();
}

function deleteMember(id) {
  const usedDeposit = deposits.some(d => d.memberId === id);
  const usedExpense = expenses.some(e => e.members?.includes(id));
  if (usedDeposit || usedExpense)
    return alert("입금/지출 기록이 있는 회원은 삭제할 수 없습니다.");
  if (!confirm("정말 삭제하시겠습니까?")) return;

  members = members.filter(m => m.id !== id);
  saveAll();
  renderMembersPage();
}

function renderMembersPage() {
  const container = document.getElementById("membersPage");
  const gm = members.filter(m => m.groupId === activeGroupId);
  if (!gm.length) {
    container.innerHTML = `<div class="card">회원이 없습니다. + 버튼으로 추가하세요.</div>`;
    return;
  }
  container.innerHTML = gm.map(m => `
    <div class="card">
      <div class="card-title">${m.name}</div>
      <button class="secondary-btn" onclick="openMemberModal(${m.id})">수정</button>
      <button class="secondary-btn" onclick="deleteMember(${m.id})">삭제</button>
    </div>
  `).join("");
}

/* ========== 6. 입금 (회비 + Donation) ========== */
function openDepositModal(id=null) {
  document.getElementById("editingDepositId").value = id || "";
  const sel = document.getElementById("depositMemberSelect");
  const gm  = members.filter(m => m.groupId === activeGroupId);
  sel.innerHTML = gm.map(m => `<option value="${m.id}">${m.name}</option>`).join("");

  if (id) {
    const d = deposits.find(x => x.id === id);
    if (d) {
      sel.value = d.memberId;
      document.getElementById("depositMonth").value = d.month || "";
      document.getElementById("depositAmount").value = d.amount;
      document.getElementById("depositType").value = d.type || "fee";
      document.getElementById("depositMemo").value = d.memo || "";
    }
  } else {
    document.getElementById("depositMonth").value = "";
    document.getElementById("depositAmount").value = "";
    document.getElementById("depositType").value = "fee";
    document.getElementById("depositMemo").value = "";
  }
  openModal("depositModal");
}

function saveDeposit() {
  const idStr = document.getElementById("editingDepositId").value;
  const memberId = Number(document.getElementById("depositMemberSelect").value);
  const month    = Number(document.getElementById("depositMonth").value);
  const amount   = Number(document.getElementById("depositAmount").value);
  const type     = document.getElementById("depositType").value;
  let memo       = document.getElementById("depositMemo").value.trim();

  if (!memberId || !amount)
    return alert("회원과 금액은 필수입니다.");

  if (!memo) {
    if (type === "fee" && month) memo = `${month}월 회비`;
    else if (type === "donation") memo = "Donation";
  }

  if (idStr) {
    const id = Number(idStr);
    const idx = deposits.findIndex(d => d.id === id);
    if (idx > -1) {
      deposits[idx].memberId = memberId;
      deposits[idx].month = month;
      deposits[idx].amount = amount;
      deposits[idx].type = type;
      deposits[idx].memo = memo;
    }
  } else {
    deposits.push({
      id: Date.now(),
      groupId: activeGroupId,
      memberId,
      month,
      amount,
      type,
      memo
    });
  }
  saveAll();
  closeModal("depositModal");
  renderDepositPage();
}

function deleteDeposit(id) {
  if (!confirm("이 입금 기록을 삭제하시겠습니까?")) return;
  deposits = deposits.filter(d => d.id !== id);
  saveAll();
  renderDepositPage();
}

function renderDepositPage() {
  const container = document.getElementById("depositPage");
  const list = deposits.filter(d => d.groupId === activeGroupId);

  if (!list.length) {
    container.innerHTML = `<div class="card">입금 기록이 없습니다.</div>`;
    return;
  }

  container.innerHTML = `
    <div class="card no-print">
      <div class="card-title">입금 내역</div>
      <div class="card-sub">회비와 Donation 기록입니다.</div>
    </div>
  ` + list.map(d => {
    const m = members.find(x => x.id === d.memberId);
    return `
      <div class="card">
        <div class="card-title">${m?.name || "(탈퇴 회원)"} — $${d.amount.toFixed(2)}</div>
        <div class="card-sub">${d.type === "donation" ? "[Donation] " : ""}${d.memo || ""}</div>
        <button class="secondary-btn" onclick="openDepositModal(${d.id})">수정</button>
        <button class="secondary-btn" onclick="deleteDeposit(${d.id})">삭제</button>
      </div>
    `;
  }).join("");
}

/* ========== 7. 지출 ========== */
function openExpenseModal(id=null) {
  document.getElementById("editingExpenseId").value = id || "";
  document.getElementById("expenseDate").value = "";
  document.getElementById("expenseAmount").value = "";
  document.getElementById("expenseMemo").value = "";

  if (id) {
    const e = expenses.find(x => x.id === id);
    if (e) {
      document.getElementById("expenseDate").value = e.date;
      document.getElementById("expenseAmount").value = e.amount;
      document.getElementById("expenseMemo").value = e.memo || "";
    }
  }
  openModal("expenseModal");
}

function saveExpense() {
  const idStr = document.getElementById("editingExpenseId").value;
  const date  = document.getElementById("expenseDate").value;
  const amount = Number(document.getElementById("expenseAmount").value);
  const memo   = document.getElementById("expenseMemo").value.trim();

  if (!date || !amount) return alert("날짜와 금액은 필수입니다.");

  if (idStr) {
    const id = Number(idStr);
    const idx = expenses.findIndex(e => e.id === id);
    if (idx > -1) {
      expenses[idx].date = date;
      expenses[idx].amount = amount;
      expenses[idx].memo = memo;
    }
  } else {
    expenses.push({
      id: Date.now(),
      groupId: activeGroupId,
      date,
      amount,
      memo,
      members: [],
      share: 0
    });
  }
  saveAll();
  closeModal("expenseModal");
  renderExpensePage();
}

function deleteExpense(id) {
  if (!confirm("이 지출 기록을 삭제하시겠습니까?")) return;
  expenses = expenses.filter(e => e.id !== id);
  saveAll();
  renderExpensePage();
}

function renderExpensePage() {
  const container = document.getElementById("expensePage");
  const list = expenses.filter(e => e.groupId === activeGroupId);
  if (!list.length) {
    container.innerHTML = `<div class="card">지출 내역이 없습니다.</div>`;
    return;
  }
  list.sort((a,b) => (a.date || "").localeCompare(b.date || ""));

  container.innerHTML = `
    <div class="card no-print">
      <div class="card-title">지출 내역</div>
      <div class="card-sub">모임비 사용 내역입니다.</div>
    </div>
  ` + list.map(e => `
    <div class="card">
      <div class="card-title">${e.date} – $${e.amount.toFixed(2)}</div>
      <div class="card-sub">${e.memo || ""}</div>
      <button class="secondary-btn" onclick="openExpenseModal(${e.id})">수정</button>
      <button class="secondary-btn" onclick="deleteExpense(${e.id})">삭제</button>
    </div>
  `).join("");
}

/* ========== 8. 빠른 입력 (2~12월 + Donation) ========== */
function renderFastInputPage() {
  const container = document.getElementById("fastInputPage");
  const gm = members.filter(m => m.groupId === activeGroupId);

  if (!gm.length) {
    container.innerHTML = `<div class="card">회원이 없습니다. 먼저 회원을 등록하세요.</div>`;
    return;
  }

  let html = `
    <div class="card">
      <div class="card-title">빠른 입력</div>
      <div class="card-sub">2〜12월 회비와 Donation을 한 번에 입력합니다.</div>
      <div style="overflow-x:auto;">
        <table style="width:100%; font-size:13px;">
          <thead>
            <tr style="background:#f0f0f0;">
              <th>회원</th>
              ${Array.from({length:11}, (_,i)=>`<th>${i+2}월</th>`).join("")}
              <th>Donation</th>
            </tr>
          </thead>
          <tbody>
  `;

  gm.forEach(m => {
    html += `<tr><td>${m.name}</td>`;
    for (let mo = 2; mo <= 12; mo++) {
      const d = deposits.find(d => d.memberId === m.id && d.month === mo && d.type === "fee");
      const val = d ? d.amount : "";
      html += `<td><input style="width:60px" id="fi_${m.id}_${mo}" value="${val}"></td>`;
    }
    const don = deposits.find(d => d.memberId === m.id && d.type === "donation");
    html += `<td><input style="width:80px" id="fi_${m.id}_don" value="${don?.amount || ""}"></td>`;
    html += `</tr>`;
  });

  html += `
          </tbody>
        </table>
      </div>
      <button class="primary-btn" onclick="saveFastInput()">저장</button>
    </div>
  `;

  container.innerHTML = html;
}

function saveFastInput() {
  const gm = members.filter(m => m.groupId === activeGroupId);

  gm.forEach(m => {
    for (let mo = 2; mo <= 12; mo++) {
      const el = document.getElementById(`fi_${m.id}_${mo}`);
      if (!el) continue;
      const val = Number(el.value);
      deposits = deposits.filter(d => !(d.memberId === m.id && d.month === mo && d.type === "fee"));
      if (val > 0) {
        deposits.push({
          id: Date.now() + Math.random(),
          groupId: activeGroupId,
          memberId: m.id,
          month: mo,
          amount: val,
          type: "fee",
          memo: `${mo}월 회비`
        });
      }
    }
    const dEl = document.getElementById(`fi_${m.id}_don`);
    const dVal = Number(dEl.value);
    deposits = deposits.filter(d => !(d.memberId === m.id && d.type === "donation"));
    if (dVal > 0) {
      deposits.push({
        id: Date.now() + Math.random(),
        groupId: activeGroupId,
        memberId: m.id,
        month: 12,
        amount: dVal,
        type: "donation",
        memo: "Donation"
      });
    }
  });

  saveAll();
  alert("빠른 입력 저장 완료!");
  renderFastInputPage();
}

/* ========== 9. 시트1 스타일: 회원별 입금 요약 ========== */
function renderDepositSummaryPage() {
  const container = document.getElementById("depositSummaryPage");
  const gm = members.filter(m => m.groupId === activeGroupId);

  if (!gm.length) {
    container.innerHTML = `<div class="card">회원이 없습니다.</div>`;
    return;
  }

  let html = `
    <div class="card no-print">
      <div class="card-title">회원별 회비/Donation 요약</div>
      <div class="card-sub">2〜12월 회비와 Donation 합계를 보여줍니다. (출력은 브라우저 인쇄 기능 사용)</div>
    </div>
    <div class="card">
      <div style="overflow-x:auto;">
        <table style="width:100%; font-size:13px;">
          <thead>
            <tr style="background:#f0f0f0;">
              <th>회원</th>
              ${Array.from({length:11}, (_,i)=>`<th>${i+2}월</th>`).join("")}
              <th>Donation</th>
              <th>합계</th>
            </tr>
          </thead>
          <tbody>
  `;

  gm.forEach(m => {
    let rowSum = 0;
    html += `<tr><td>${m.name}</td>`;
    for (let mo = 2; mo <= 12; mo++) {
      const d = deposits.find(d => d.memberId === m.id && d.month === mo && d.type === "fee");
      const val = d ? d.amount : 0;
      rowSum += val;
      html += `<td style="text-align:center">${val ? "$"+val.toFixed(2) : ""}</td>`;
    }
    const don = deposits.find(d => d.memberId === m.id && d.type === "donation");
    const dVal = don ? don.amount : 0;
    rowSum += dVal;
    html += `<td style="text-align:center">${dVal ? "$"+dVal.toFixed(2) : ""}</td>`;
    html += `<td style="text-align:center; font-weight:600">$${rowSum.toFixed(2)}</td>`;
    html += `</tr>`;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

/* ========== 10. 시트2 스타일: 지출 요약 ========== */
function renderExpenseSummaryPage() {
  const container = document.getElementById("expenseSummaryPage");
  const list = expenses.filter(e => e.groupId === activeGroupId);
  if (!list.length) {
    container.innerHTML = `<div class="card">지출 내역이 없습니다.</div>`;
    return;
  }

  list.sort((a,b) => (a.date || "").localeCompare(b.date || ""));

  let html = `
    <div class="card no-print">
      <div class="card-title">지출 요약</div>
      <div class="card-sub">엑셀 시트2 형태로 출력할 수 있습니다. (인쇄 기능 사용)</div>
    </div>
    <div class="card">
      <table style="width:100%; font-size:13px;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th>날짜</th>
            <th>내용</th>
            <th>금액</th>
          </tr>
        </thead>
        <tbody>
  `;
  list.forEach(e => {
    html += `
      <tr>
        <td>${e.date}</td>
        <td>${e.memo || ""}</td>
        <td style="text-align:right">$${e.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  html += `
        </tbody>
      </table>
    </div>
  `;
  container.innerHTML = html;
}

/* ========== 11. 정산 페이지 (이월 + 입금 + 지출) ========== */
function renderSummaryPage() {
  const container = document.getElementById("summaryPage");
  const g = getActiveGroup();
  if (!g) {
    container.innerHTML = `<div class="card">모임 정보가 없습니다.</div>`;
    return;
  }
  const opening = g.openingBalance || 0;
  const totalDeposit = deposits.filter(d => d.groupId === activeGroupId)
    .reduce((a,b)=>a+b.amount,0);
  const totalExpense = expenses.filter(e => e.groupId === activeGroupId)
    .reduce((a,b)=>a+b.amount,0);
  const finalBalance = opening + totalDeposit - totalExpense;

  container.innerHTML = `
    <div class="card">
      <div class="card-title">정산 요약</div>
      <div>전년도 이월금: <b>$${opening.toFixed(2)}</b></div>
      <div>총 입금 (회비+Donation): <b>$${totalDeposit.toFixed(2)}</b></div>
      <div>총 지출: <b>$${totalExpense.toFixed(2)}</b></div>
      <hr>
      <div style="font-size:20px; font-weight:700;">
        잔액: $${finalBalance.toFixed(2)}
      </div>
    </div>
    <div class="card no-print">
      <div class="card-sub">상단 브라우저 메뉴의 인쇄 기능을 이용해 정산 내역을 출력할 수 있습니다.</div>
    </div>
  `;
}

/* ========== 12. 백업 / 복원 (JSON) ========== */
function exportBackup() {
  const data = {
    groups,
    members,
    deposits,
    expenses,
    activeGroupId
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const today = new Date().toISOString().slice(0,10);
  a.download = `moim_backup_${today}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function importBackup() {
  document.getElementById("backupFile").value = "";
  document.getElementById("backupFile").click();
}

function handleBackupFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      groups       = data.groups || [];
      members      = data.members || [];
      deposits     = data.deposits || [];
      expenses     = data.expenses || [];
      activeGroupId = data.activeGroupId || (groups[0] && groups[0].id);
      saveAll();
      refreshHeader();
      renderAll();
      alert("복원 완료!");
    } catch (err) {
      console.error(err);
      alert("복원 실패. JSON 형식을 확인하세요.");
    }
  };
  reader.readAsText(file, "utf-8");
}

/* ========== 13. 전체 렌더 + 초기 진입 페이지 ========== */
function renderAll() {
  refreshHeader();
  renderMembersPage();
  renderDepositPage();
  renderExpensePage();
  renderFastInputPage();
  renderDepositSummaryPage();
  renderExpenseSummaryPage();
  renderSummaryPage();
}

/* 초기: '입금' 페이지를 첫 화면으로 */
showPage("depositPage");

/* ========== 14. PWA Service Worker 등록 ========== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => {
      console.log('ServiceWorker 등록 실패:', err);
    });
  });
}
</script>

</body>
</html>
